name: Auto-Grade Student Submissions

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  detect-assignment:
    runs-on: ubuntu-latest
    outputs:
      week: ${{ steps.detect.outputs.week }}
      assignment: ${{ steps.detect.outputs.assignment }}
    steps:
      - name: Detect Assignment Week
        id: detect
        run: |
          BRANCH_NAME="${{ github.head_ref }}"

          echo "ğŸ” Detecting assignment from branch: $BRANCH_NAME"

          # Extract week number from branch name (e.g., assignment/week-02 or assignments/week-2)
          if [[ "$BRANCH_NAME" =~ assignments?/week-0?([0-9]+) ]]; then
            WEEK="${BASH_REMATCH[1]}"
            echo "âœ… Detected week: $WEEK"
          else
            echo "::error::Could not detect week number from branch name"
            echo "::error::Expected format: assignment/week-XX or assignments/week-XX"
            echo "::error::Branch: $BRANCH_NAME"
            exit 1
          fi

          # Pad week number to 2 digits
          WEEK=$(printf "%02d" $WEEK)

          # Map week to assignment folder
          case $WEEK in
            01) ASSIGNMENT="week-01-hello-github" ;;
            02) ASSIGNMENT="week-02-calculator-lite" ;;
            03) ASSIGNMENT="week-03-profile-card" ;;
            05) ASSIGNMENT="week-05-guess-the-number" ;;
            *)
              echo "::error::Week $WEEK not yet configured in workflow"
              echo "::error::Available weeks: 01, 02, 03, 05"
              exit 1
              ;;
          esac

          echo "week=$WEEK" >> $GITHUB_OUTPUT
          echo "assignment=$ASSIGNMENT" >> $GITHUB_OUTPUT
          echo "âœ… Detected: Week $WEEK - $ASSIGNMENT"

  test-assignment:
    needs: detect-assignment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Request Instructor Review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                reviewers: ['ZakBrinlee']
              });
              console.log('âœ… Review requested from ZakBrinlee');
            } catch (error) {
              console.log('âš ï¸ Could not request review:', error.message);
              // Don't fail the workflow if review request fails
            }

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Display Assignment Info
        run: |
          echo "ğŸ“š Testing Week ${{ needs.detect-assignment.outputs.week }}"
          echo "ğŸ“ Assignment: ${{ needs.detect-assignment.outputs.assignment }}"

      - name: Restore dependencies
        run: |
          cd modules/${{ needs.detect-assignment.outputs.assignment }}/tests
          dotnet restore

      - name: Build starter project
        run: |
          cd modules/${{ needs.detect-assignment.outputs.assignment }}/starter
          dotnet build --no-restore

      - name: Build test project
        run: |
          cd modules/${{ needs.detect-assignment.outputs.assignment }}/tests
          dotnet build --no-restore

      - name: Run tests
        id: test
        run: |
          cd modules/${{ needs.detect-assignment.outputs.assignment }}

          # Run tests and capture output
          dotnet test tests --no-build --verbosity normal --logger "console;verbosity=detailed" > test-output.txt 2>&1 || true

          # Display output in workflow logs
          echo "ğŸ“Š Test Output:"
          cat test-output.txt

          # Check if tests passed
          if grep -q "Test Run Successful" test-output.txt; then
            echo "status=passed" >> $GITHUB_OUTPUT
            echo "âœ… All tests passed!"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ Some tests failed"
          fi

      - name: Parse test results
        id: results
        run: |
          cd modules/${{ needs.detect-assignment.outputs.assignment }}

          # Extract test summary
          PASSED=$(grep -oP "Passed: \K\d+" test-output.txt | head -1 || echo "0")
          FAILED=$(grep -oP "Failed: \K\d+" test-output.txt | head -1 || echo "0")
          SKIPPED=$(grep -oP "Skipped: \K\d+" test-output.txt | head -1 || echo "0")
          TOTAL=$(grep -oP "Total: \K\d+" test-output.txt | head -1 || echo "0")

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          # Calculate grade (assuming 100 points max)
          if [ $TOTAL -gt 0 ]; then
            GRADE=$((PASSED * 100 / TOTAL))
          else
            GRADE=0
          fi
          echo "grade=$GRADE" >> $GITHUB_OUTPUT

          echo "ğŸ“Š Results: $PASSED passed, $FAILED failed, $SKIPPED skipped out of $TOTAL total"
          echo "ğŸ¯ Grade: $GRADE/100"

      - name: Comment PR with results
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const testOutputPath = 'modules/${{ needs.detect-assignment.outputs.assignment }}/test-output.txt';
            let testOutput = '';

            try {
              testOutput = fs.readFileSync(testOutputPath, 'utf8');
            } catch (error) {
              testOutput = 'Could not read test output';
            }

            const passed = parseInt('${{ steps.results.outputs.passed }}') || 0;
            const failed = parseInt('${{ steps.results.outputs.failed }}') || 0;
            const skipped = parseInt('${{ steps.results.outputs.skipped }}') || 0;
            const total = parseInt('${{ steps.results.outputs.total }}') || 0;
            const grade = parseInt('${{ steps.results.outputs.grade }}') || 0;
            const status = '${{ steps.test.outputs.status }}';

            // Extract failed test details
            const failedTests = [];
            const lines = testOutput.split('\n');
            for (let i = 0; i < lines.length; i++) {
              if (lines[i].includes('Failed') && (lines[i].includes('Test') || lines[i].includes('TEST'))) {
                const testName = lines[i].trim();
                if (!testName.startsWith('Failed:') && testName.length > 0) {
                  failedTests.push(testName);
                }
              }
            }

            const emoji = status === 'passed' ? 'âœ…' : 'âŒ';
            const gradeEmoji = grade >= 90 ? 'ğŸŒŸ' : grade >= 80 ? 'ğŸ‰' : grade >= 70 ? 'ğŸ‘' : grade >= 60 ? 'ğŸ“š' : 'ğŸ’ª';

            let comment = `## ${emoji} Test Results - Week ${{ needs.detect-assignment.outputs.week }}\n\n`;
            comment += `**Assignment:** \`${{ needs.detect-assignment.outputs.assignment }}\`\n\n`;
            comment += `### ${gradeEmoji} Score: ${grade}/100\n\n`;
            comment += `| Status | Count |\n`;
            comment += `|--------|-------|\n`;
            comment += `| âœ… Passed | ${passed}/${total} |\n`;
            comment += `| âŒ Failed | ${failed}/${total} |\n`;
            if (skipped > 0) {
              comment += `| â­ï¸ Skipped | ${skipped}/${total} |\n`;
            }
            comment += `\n`;

            if (status === 'passed') {
              comment += `### ğŸ‰ Excellent work! All tests passed!\n\n`;
              comment += `Your assignment meets all requirements and is ready for review.\n\n`;
              comment += `#### Next Steps:\n`;
              comment += `- Wait for instructor feedback\n`;
              comment += `- Once approved, your PR will be merged\n`;
            } else {
              comment += `### ğŸ“ Tests that need attention:\n\n`;
              if (failedTests.length > 0) {
                const uniqueTests = [...new Set(failedTests)].slice(0, 10);
                uniqueTests.forEach(test => {
                  comment += `- ${test}\n`;
                });
                if (failedTests.length > 10) {
                  comment += `\n_...and ${failedTests.length - 10} more. See detailed output below._\n`;
                }
              } else {
                comment += `See detailed test output below for more information.\n`;
              }
              comment += `\n### ğŸ’¡ Next Steps:\n\n`;
              comment += `1. Review the failed tests above\n`;
              comment += `2. Run tests locally to debug:\n`;
              comment += `  From the assignment's starter directory\n`;
              comment += `   \`\`\`bash\n`;
              comment += `   dotnet test ../tests ${{ needs.detect-assignment.outputs.week }}\n`;
              comment += `   \`\`\`\n`;
              comment += `3. Make necessary corrections to your code\n`;
              comment += `4. Commit and push your changes\n`;
              comment += `5. Tests will automatically re-run\n`;
            }

            comment += `\n---\n\n`;
            comment += `<details>\n<summary>ğŸ“Š View detailed test output</summary>\n\n`;
            comment += `\`\`\`\n${testOutput.substring(0, 60000)}\n\`\`\`\n\n`;
            comment += `</details>\n\n`;
            comment += `---\n`;
            const now = new Date();
            const pstString = now.toLocaleString('en-US', {
              timeZone: 'America/Los_Angeles',
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
              hour12: false
            });
            // Convert from "01/02/2026, 15:30:45" to "01-02-2026 15:30:45"
            const timestamp = pstString.replace(/(\d{2})\/(\d{2})\/(\d{4}), (\d{2}:\d{2}:\d{2})/, '$1-$2-$3 $4');
            comment += `*Automated grading system â€¢ [Learn more](../../docs/GRADING_SYSTEM.md)*\n\n`;
            comment += `*Last updated: ${timestamp} PST*`;

            // Find existing bot comments
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Test Results - Week')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('Updated existing comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              console.log('Created new comment');
            }

      - name: Set check status
        if: always()
        run: |
          if [ "${{ steps.test.outputs.status }}" == "passed" ]; then
            echo "âœ… All tests passed"
            exit 0
          else
            echo "âŒ Some tests failed - merge blocked"
            echo "Instructor can override by commenting '/override-tests' on the PR"
            exit 1
          fi
